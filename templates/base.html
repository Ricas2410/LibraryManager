<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ library_settings.library_name|default:"Library Management System" }}{% endblock %}</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="{% block description %}{{ library_settings.library_name|default:'Library Management System' }} - Digital library management for Deigratia Montessori School. Browse books, manage loans, and track reading progress.{% endblock %}">
    <meta name="keywords" content="library, books, education, Deigratia Montessori School, digital library, book management, student reading">
    <meta name="author" content="{{ library_settings.library_name|default:'Library Management System' }}">
    <meta name="robots" content="index, follow">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="{% block og_title %}{{ library_settings.library_name|default:'Library Management System' }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Digital library management system for Deigratia Montessori School{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    {% if library_settings.library_logo %}
        {% load library_settings_tags %}
        <meta property="og:image" content="{% safe_cloudinary_url library_settings.library_logo width=1200 height=630 crop='fill' %}">
    {% endif %}

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}{{ library_settings.library_name|default:'Library Management System' }}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}Digital library management system for Deigratia Montessori School{% endblock %}">
    {% if library_settings.library_logo %}
        <meta name="twitter:image" content="{% safe_cloudinary_url library_settings.library_logo width=1200 height=630 crop='fill' %}">
    {% endif %}

    <!-- Favicon -->
    {% if library_settings.library_logo %}
        {% load library_settings_tags %}
        <link rel="icon" type="image/x-icon" href="{% safe_cloudinary_url library_settings.library_logo width=32 height=32 crop='fill' format='ico' %}">
        <link rel="shortcut icon" type="image/x-icon" href="{% safe_cloudinary_url library_settings.library_logo width=32 height=32 crop='fill' format='ico' %}">
        <link rel="apple-touch-icon" sizes="180x180" href="{% safe_cloudinary_url library_settings.library_logo width=180 height=180 crop='fill' %}">
        <link rel="icon" type="image/png" sizes="32x32" href="{% safe_cloudinary_url library_settings.library_logo width=32 height=32 crop='fill' %}">
        <link rel="icon" type="image/png" sizes="16x16" href="{% safe_cloudinary_url library_settings.library_logo width=16 height=16 crop='fill' %}">
    {% else %}
        <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“š</text></svg>">
    {% endif %}

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'bounce-subtle': 'bounceSubtle 2s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideIn: {
                            '0%': { transform: 'translateY(-10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        bounceSubtle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.4);
        }

        .sidebar-item {
            transition: all 0.2s ease;
        }

        .sidebar-item:hover {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
        }

        .notification-badge {
            animation: pulse 2s infinite;
        }

        /* Form field styling to ensure visibility */
        .form-control,
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        input[type="tel"],
        textarea,
        select {
            background-color: #ffffff !important;
            border: 2px solid #d1d5db !important;
            border-radius: 8px !important;
            padding: 12px 16px !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            color: #374151 !important;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1) !important;
            transition: all 0.2s ease-in-out !important;
        }

        .form-control:focus,
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        input[type="tel"]:focus,
        textarea:focus,
        select:focus {
            outline: none !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }

        .form-control::placeholder,
        input::placeholder,
        textarea::placeholder {
            color: #b9bcc2ff !important;
        }

        /* Ensure form labels are visible */
        label {
            color: #575e68ff !important;
            font-weight: 500 !important;
            margin-bottom: 8px !important;
            display: block !important;
        }
    </style>

    <!-- Custom CSS -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/library.css' %}">

    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen font-sans">










    <!-- Messages -->
    {% if messages %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6">
        {% for message in messages %}
        <div class="mb-4 animate-slide-in">
            <div class="p-4 rounded-2xl shadow-lg {% if message.tags == 'error' %}bg-gradient-to-r from-red-50 to-red-100 border-l-4 border-red-500{% elif message.tags == 'warning' %}bg-gradient-to-r from-yellow-50 to-yellow-100 border-l-4 border-yellow-500{% elif message.tags == 'success' %}bg-gradient-to-r from-green-50 to-green-100 border-l-4 border-green-500{% else %}bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-500{% endif %}">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center {% if message.tags == 'error' %}bg-red-500{% elif message.tags == 'warning' %}bg-yellow-500{% elif message.tags == 'success' %}bg-green-500{% else %}bg-blue-500{% endif %}">
                            {% if message.tags == 'error' %}
                            <i class="fas fa-exclamation-circle text-white text-sm"></i>
                            {% elif message.tags == 'warning' %}
                            <i class="fas fa-exclamation-triangle text-white text-sm"></i>
                            {% elif message.tags == 'success' %}
                            <i class="fas fa-check-circle text-white text-sm"></i>
                            {% else %}
                            <i class="fas fa-info-circle text-white text-sm"></i>
                            {% endif %}
                        </div>
                    </div>
                    <div class="ml-4 flex-1">
                        <div class="{% if message.tags == 'error' %}text-red-800{% elif message.tags == 'warning' %}text-yellow-800{% elif message.tags == 'success' %}text-green-800{% else %}text-blue-800{% endif %} font-medium">
                            {{ message }}
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" class="ml-4 {% if message.tags == 'error' %}text-red-500 hover:text-red-700{% elif message.tags == 'warning' %}text-yellow-500 hover:text-yellow-700{% elif message.tags == 'success' %}text-green-500 hover:text-green-700{% else %}text-blue-500 hover:text-blue-700{% endif %} transition-colors duration-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Main Layout with Sidebar -->
    {% if user.is_authenticated %}
    <div class="flex min-h-screen bg-gray-50">
        <!-- Mobile sidebar overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 z-40 bg-gray-600 bg-opacity-75 hidden lg:hidden"></div>

        <!-- Sidebar (responsive for both desktop and mobile) -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-gradient-to-b from-slate-800 to-slate-900 transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0 lg:flex lg:flex-shrink-0">
            <div class="flex flex-col w-64 h-full">
                <div class="flex flex-col h-full bg-gradient-to-b from-slate-800 to-slate-900 border-r border-slate-700">
                    <!-- Fixed Header -->
                    <div class="flex items-center justify-between flex-shrink-0 px-4 py-5 border-b border-slate-700">
                        <div class="flex items-center space-x-3">
                            {% if library_settings.library_logo %}
                                {% load library_settings_tags %}
                                <img src="{% safe_cloudinary_url library_settings.library_logo width=32 height=32 crop='fill' %}"
                                     alt="{{ library_settings.library_name }} Logo"
                                     class="w-8 h-8 rounded-lg object-cover">
                            {% else %}
                                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-book-open text-white text-sm"></i>
                                </div>
                            {% endif %}
                            <div>
                                <h2 class="text-lg font-semibold text-white">{{ library_settings.library_name|default:"LibraryPro"|truncatewords:2 }}</h2>
                                <p class="text-xs text-slate-300">Management System</p>
                            </div>
                        </div>
                        <!-- Mobile close button -->
                        <button onclick="closeSidebar()" class="lg:hidden text-slate-400 hover:text-white p-2">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>

                    <!-- Scrollable Navigation -->
                    <nav class="flex-1 px-2 py-4 space-y-1 overflow-y-auto scrollbar-thin scrollbar-thumb-slate-600 scrollbar-track-slate-800">
                        <!-- Dashboard -->
                        <a href="{% url 'home' %}" class="sidebar-item group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'home' %}bg-blue-600 text-white{% else %}text-slate-300 hover:bg-slate-700 hover:text-white{% endif %} transition-all duration-200">
                            <i class="fas fa-home mr-3 text-lg"></i>
                            Dashboard
                        </a>

                        <!-- Books (moved to top for students) -->
                        <a href="{% url 'book_list' %}" class="sidebar-item group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if 'book' in request.resolver_match.url_name %}bg-blue-600 text-white{% else %}text-slate-300 hover:bg-slate-700 hover:text-white{% endif %} transition-all duration-200">
                            <i class="fas fa-books mr-3 text-lg"></i>
                            Books
                        </a>

                        {% if user.can_borrow_books %}
                        <!-- Student Dashboard -->
                        <a href="{% url 'student_dashboard' %}" class="sidebar-item group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'student_dashboard' %}bg-blue-600 text-white{% else %}text-slate-300 hover:bg-slate-700 hover:text-white{% endif %} transition-all duration-200">
                            <i class="fas fa-user-graduate mr-3 text-lg"></i>
                            My Library
                        </a>

                        <!-- Student Quick Links Section -->
                        <div class="mt-6">
                            <h3 class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider">My Account</h3>
                            <div class="mt-2 space-y-1">
                                <!-- My Profile -->
                                <a href="{% url 'profile' %}" class="sidebar-item group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'profile' %}bg-blue-600 text-white{% else %}text-slate-300 hover:bg-slate-700 hover:text-white{% endif %} transition-all duration-200">
                                    <i class="fas fa-user mr-3 text-lg"></i>
                                    My Profile
                                </a>

                                <!-- My Loans -->
                                <a href="{% url 'my_loans' %}" class="sidebar-item group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'my_loans' %}bg-blue-600 text-white{% else %}text-slate-300 hover:bg-slate-700 hover:text-white{% endif %} transition-all duration-200">
                                    <i class="fas fa-book-reader mr-3 text-lg"></i>
                                    My Loans
                                </a>

                                <!-- My Reservations -->
                                <a href="{% url 'my_reservations' %}" class="sidebar-item group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'my_reservations' %}bg-blue-600 text-white{% else %}text-slate-300 hover:bg-slate-700 hover:text-white{% endif %} transition-all duration-200">
                                    <i class="fas fa-bookmark mr-3 text-lg"></i>
                                    My Reservations
                                </a>

                                <!-- Pending Requests -->
                                <a href="{% url 'my_pending_requests' %}" class="sidebar-item group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if request.resolver_match.url_name == 'my_pending_requests' %}bg-blue-600 text-white{% else %}text-slate-300 hover:bg-slate-700 hover:text-white{% endif %} transition-all duration-200">
                                    <i class="fas fa-clock mr-3 text-lg"></i>
                                    Pending Requests
                                </a>

                                <!-- Reading History -->
                                <a href="{% url 'reading_history' %}" class="sidebar-item group flex items-center px-3 py-3 text-sm font-medium rounded-lg {% if 'reading_history' in request.resolver_match.url_name %}bg-blue-600 text-white{% else %}text-slate-300 hover:bg-slate-700 hover:text-white{% endif %} transition-all duration-200">
                                    <i class="fas fa-history mr-3 text-lg"></i>
                                    Reading History
                                </a>
                            </div>
                        </div>
                        {% endif %}

                        {% if user.can_manage_books %}
                        <!-- Loan Management Section -->
                        <div class="mt-6">
                            <h3 class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Loan Management</h3>
                            <div class="mt-2 space-y-1">
                                <!-- Loans -->
                                <a href="{% url 'loan_list' %}" class="sidebar-item group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'loan' in request.resolver_match.url_name and 'overdue' not in request.resolver_match.url_name and 'due-soon' not in request.resolver_match.url_name %}bg-blue-100 text-blue-700 border-r-2 border-blue-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                                    <i class="fas fa-hand-holding mr-3 text-lg"></i>
                                    All Loans
                                </a>

                                <!-- Pending Requests -->
                                <a href="{% url 'pending_requests' %}" class="sidebar-item group flex items-center justify-between px-2 py-2 text-sm font-medium rounded-md {% if request.resolver_match.url_name == 'pending_requests' %}bg-blue-100 text-blue-700 border-r-2 border-blue-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                                    <div class="flex items-center">
                                        <i class="fas fa-clock mr-3 text-lg"></i>
                                        Pending Requests
                                    </div>
                                    {% if pending_requests_count > 0 %}
                                    <span class="bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center animate-pulse">{{ pending_requests_count }}</span>
                                    {% endif %}
                                </a>

                                <!-- Overdue Books -->
                                <a href="{% url 'overdue_loans' %}" class="sidebar-item group flex items-center justify-between px-2 py-2 text-sm font-medium rounded-md {% if request.resolver_match.url_name == 'overdue_loans' %}bg-red-100 text-red-700 border-r-2 border-red-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                                    <div class="flex items-center">
                                        <i class="fas fa-exclamation-triangle mr-3 text-lg"></i>
                                        Overdue Books
                                    </div>
                                    {% if overdue_loans_count > 0 %}
                                    <span class="bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center animate-pulse">{{ overdue_loans_count }}</span>
                                    {% endif %}
                                </a>

                                <!-- Due Soon -->
                                <a href="{% url 'due_soon_loans' %}" class="sidebar-item group flex items-center justify-between px-2 py-2 text-sm font-medium rounded-md {% if request.resolver_match.url_name == 'due_soon_loans' %}bg-yellow-100 text-yellow-700 border-r-2 border-yellow-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                                    <div class="flex items-center">
                                        <i class="fas fa-clock mr-3 text-lg"></i>
                                        Due Soon
                                    </div>
                                    {% if due_soon_loans_count > 0 %}
                                    <span class="bg-yellow-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center animate-pulse">{{ due_soon_loans_count }}</span>
                                    {% endif %}
                                </a>

                                <!-- Issue Loan -->
                                <a href="{% url 'loan_create' %}" class="sidebar-item group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if request.resolver_match.url_name == 'loan_create' %}bg-blue-100 text-blue-700 border-r-2 border-blue-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                                    <i class="fas fa-plus-circle mr-3 text-lg"></i>
                                    Issue Loan
                                </a>
                            </div>
                        </div>

                        <!-- Library Management Section -->
                        <div class="mt-6">
                            <h3 class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Library Management</h3>
                            <div class="mt-2 space-y-1">
                                <!-- Authors -->
                                <a href="{% url 'author_list' %}" class="sidebar-item group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'author' in request.resolver_match.url_name %}bg-blue-100 text-blue-700 border-r-2 border-blue-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                                    <i class="fas fa-user-edit mr-3 text-lg"></i>
                                    Authors
                                </a>

                                <!-- Categories -->
                                <a href="{% url 'category_list' %}" class="sidebar-item group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'category' in request.resolver_match.url_name %}bg-blue-100 text-blue-700 border-r-2 border-blue-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                                    <i class="fas fa-tags mr-3 text-lg"></i>
                                    Categories
                                </a>

                                <!-- Publishers -->
                                <a href="{% url 'publisher_list' %}" class="sidebar-item group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'publisher' in request.resolver_match.url_name %}bg-blue-100 text-blue-700 border-r-2 border-blue-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                                    <i class="fas fa-building mr-3 text-lg"></i>
                                    Publishers
                                </a>

                                <!-- Sections -->
                                <a href="{% url 'section_list' %}" class="sidebar-item group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'section' in request.resolver_match.url_name %}bg-blue-100 text-blue-700 border-r-2 border-blue-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                                    <i class="fas fa-layer-group mr-3 text-lg"></i>
                                    Sections
                                </a>

                                <!-- Shelf Locations -->
                                <a href="{% url 'shelf_location_list' %}" class="sidebar-item group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'shelf' in request.resolver_match.url_name %}bg-blue-100 text-blue-700 border-r-2 border-blue-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                                    <i class="fas fa-map-marker-alt mr-3 text-lg"></i>
                                    Shelf Locations
                                </a>

                                <!-- Floors -->
                                <a href="{% url 'floor_list' %}" class="sidebar-item group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'floor' in request.resolver_match.url_name %}bg-blue-100 text-blue-700 border-r-2 border-blue-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                                    <i class="fas fa-building mr-3 text-lg"></i>
                                    Floors
                                </a>
                            </div>
                        </div>

                        <!-- Reports Section -->
                        <div class="mt-6">
                            <h3 class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Reports & Analytics</h3>
                            <div class="mt-2 space-y-1">
                                <!-- Reports -->
                                <a href="{% url 'reports_dashboard' %}" class="sidebar-item group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'report' in request.resolver_match.url_name %}bg-blue-100 text-blue-700 border-r-2 border-blue-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                                    <i class="fas fa-chart-bar mr-3 text-lg"></i>
                                    Reports Dashboard
                                </a>

                                <!-- Reading History & Leaderboard -->
                                <a href="{% url 'admin_reading_history' %}" class="sidebar-item group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'admin_reading_history' in request.resolver_match.url_name or 'student_reading_detail' in request.resolver_match.url_name %}bg-blue-100 text-blue-700 border-r-2 border-blue-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                                    <i class="fas fa-trophy mr-3 text-lg"></i>
                                    Reading Leaderboard
                                </a>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Search -->
                        <a href="{% url 'advanced_search' %}" class="sidebar-item group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'search' in request.resolver_match.url_name %}bg-blue-100 text-blue-700 border-r-2 border-blue-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                            <i class="fas fa-search mr-3 text-lg"></i>
                            Advanced Search
                        </a>

                        {% if user.can_manage_users %}
                        <!-- Users -->
                        <a href="{% url 'user_list' %}" class="sidebar-item group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'user' in request.resolver_match.url_name %}bg-blue-100 text-blue-700 border-r-2 border-blue-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                            <i class="fas fa-users mr-3 text-lg"></i>
                            User Management
                        </a>

                        <!-- Settings -->
                        <a href="{% url 'library_settings' %}" class="sidebar-item group flex items-center px-2 py-2 text-sm font-medium rounded-md {% if 'settings' in request.resolver_match.url_name %}bg-blue-100 text-blue-700 border-r-2 border-blue-700{% else %}text-gray-200 hover:bg-gray-700 hover:text-white{% endif %}">
                            <i class="fas fa-cog mr-3 text-lg"></i>
                            Library Settings
                        </a>
                        {% endif %}

                        <!-- Quick Actions -->
                        {% if user.can_manage_books %}
                        <div class="pt-4 mt-4 border-t border-gray-200">
                            <p class="px-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">Quick Actions</p>
                            <div class="mt-2 space-y-1">
                                <a href="{% url 'book_add' %}" class="group flex items-center px-2 py-2 text-sm font-medium text-gray-600 rounded-md hover:bg-green-50 hover:text-green-700">
                                    <i class="fas fa-plus mr-3 text-green-600"></i>
                                    Add Book
                                </a>
                                <a href="{% url 'loan_create' %}" class="group flex items-center px-2 py-2 text-sm font-medium text-gray-600 rounded-md hover:bg-orange-50 hover:text-orange-700">
                                    <i class="fas fa-hand-holding mr-3 text-orange-600"></i>
                                    Issue Loan
                                </a>
                                <a href="{% url 'pending_requests' %}" class="group flex items-center px-2 py-2 text-sm font-medium text-gray-600 rounded-md hover:bg-blue-50 hover:text-blue-700">
                                    <i class="fas fa-clock mr-3 text-blue-600"></i>
                                    Review Requests
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </nav>

                    <!-- User Info at Bottom -->
                    <div class="flex-shrink-0 flex border-t border-gray-200 p-4">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                                {% if user.profile_picture %}
                                <img src="{{ user.profile_picture.url }}" alt="Profile" class="w-8 h-8 rounded-full object-cover">
                                {% else %}
                                <i class="fas fa-user text-gray-600 text-sm"></i>
                                {% endif %}
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-700">{{ user.get_full_name|default:user.username }}</p>
                                <p class="text-xs text-gray-500">{{ user.get_role_display }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Main content -->
        <div class="flex flex-col w-0 flex-1 overflow-hidden">
            <!-- Top navigation - Mobile First -->
            <div class="relative z-10 flex-shrink-0 flex h-16 bg-gradient-to-r from-blue-600 to-purple-700 shadow-lg">
                <!-- Mobile menu button -->
                <button class="px-4 border-r border-white/20 text-white/80 hover:text-white focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white/50 lg:hidden transition-colors duration-200" onclick="toggleSidebar()">
                    <i class="fas fa-bars text-xl"></i>
                </button>

                <!-- Main navbar content -->
                <div class="flex-1 px-3 sm:px-4 flex justify-between items-center">
                    <!-- Responsive Search bar -->
                    <div class="flex-1 max-w-lg mr-4 relative">
                        <form action="{% url 'advanced_search' %}" method="get" class="relative" id="navbar-search-form">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none z-10">
                                <i class="fas fa-search text-gray-500 text-sm"></i>
                            </div>
                            <input id="search-field"
                                   name="query"
                                   class="block w-full pl-10 pr-3 py-2 border border-white/30 rounded-lg text-sm text-gray-900 placeholder-gray-500 bg-white/90 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-white/50 focus:bg-white transition-all duration-200"
                                   placeholder="Search books, users..."
                                   type="text"
                                   autocomplete="off"
                                   tabindex="0">
                        </form>
                        <!-- Live Search Results -->
                        <div id="search-results" class="absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 hidden max-h-96 overflow-y-auto">
                            <!-- Results will be populated here -->
                        </div>
                    </div>

                    <!-- Right side icons -->
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <!-- Unified Notifications -->
                        <div class="relative group">
                            <button id="notifications-btn" class="bg-white/10 hover:bg-white/20 p-2 rounded-full text-white/80 hover:text-white focus:outline-none focus:ring-2 focus:ring-white/50 relative transition-all duration-200">
                                <i class="fas fa-bell text-lg sm:text-xl"></i>
                                <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center {% if total_notifications == 0 %}hidden{% endif %} font-medium">{{ total_notifications|default:0 }}</span>
                            </button>

                            <!-- Comprehensive Notifications Dropdown -->
                            <div id="notifications-dropdown" class="opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 absolute right-0 mt-2 w-72 sm:w-96 bg-white rounded-xl shadow-2xl border border-gray-200 z-50 max-w-[calc(100vw-1rem)] sm:max-w-none">
                                <div class="p-3 sm:p-4 border-b border-gray-200">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-base sm:text-lg font-semibold text-gray-900 flex items-center">
                                            <i class="fas fa-bell mr-1 sm:mr-2 text-blue-600 text-sm sm:text-base"></i>
                                            <span class="hidden sm:inline">Notifications</span>
                                            <span class="sm:hidden">Alerts</span>
                                        </h3>
                                        <button id="mark-all-read-btn" onclick="markAllNotificationsRead()" class="text-xs sm:text-sm text-blue-600 hover:text-blue-800 font-medium">Mark all read</button>
                                    </div>
                                </div>

                                <!-- Admin Notifications Section -->
                                {% if user.role == 'librarian' or user.role == 'admin' or user.is_superuser %}
                                <div class="border-b border-gray-200">
                                    <div class="p-2 sm:p-3 bg-blue-50">
                                        <h4 class="text-xs sm:text-sm font-semibold text-blue-900 flex items-center">
                                            <i class="fas fa-tasks mr-1 sm:mr-2 text-xs sm:text-sm"></i>
                                            <span class="hidden sm:inline">Admin Tasks</span>
                                            <span class="sm:hidden">Tasks</span>
                                        </h4>
                                    </div>
                                    <div class="p-2 space-y-1">
                                        {% if pending_requests_count > 0 %}
                                        <a href="{% url 'pending_requests' %}" class="block p-2 sm:p-3 hover:bg-gray-50 rounded-lg transition-colors duration-200">
                                            <div class="flex items-center">
                                                <div class="w-6 h-6 sm:w-8 sm:h-8 bg-blue-100 rounded-full flex items-center justify-center mr-2 sm:mr-3">
                                                    <i class="fas fa-clock text-blue-600 text-xs sm:text-sm"></i>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-xs sm:text-sm font-medium text-gray-900 truncate">{{ pending_requests_count }} Pending Request{{ pending_requests_count|pluralize }}</p>
                                                    <p class="text-xs text-gray-500 hidden sm:block">Students waiting for approval</p>
                                                </div>
                                                <span class="bg-blue-100 text-blue-800 text-xs font-medium px-1.5 py-0.5 sm:px-2 sm:py-1 rounded-full">{{ pending_requests_count }}</span>
                                            </div>
                                        </a>
                                        {% endif %}

                                        {% if overdue_loans_count > 0 %}
                                        <a href="{% url 'overdue_loans' %}" class="block p-2 sm:p-3 hover:bg-gray-50 rounded-lg transition-colors duration-200">
                                            <div class="flex items-center">
                                                <div class="w-6 h-6 sm:w-8 sm:h-8 bg-red-100 rounded-full flex items-center justify-center mr-2 sm:mr-3">
                                                    <i class="fas fa-exclamation-triangle text-red-600 text-xs sm:text-sm"></i>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-xs sm:text-sm font-medium text-gray-900 truncate">{{ overdue_loans_count }} Overdue Book{{ overdue_loans_count|pluralize }}</p>
                                                    <p class="text-xs text-gray-500 hidden sm:block">Immediate attention needed</p>
                                                </div>
                                                <span class="bg-red-100 text-red-800 text-xs font-medium px-1.5 py-0.5 sm:px-2 sm:py-1 rounded-full">{{ overdue_loans_count }}</span>
                                            </div>
                                        </a>
                                        {% endif %}

                                        {% if total_admin_notifications == 0 %}
                                        <div class="p-2 sm:p-3 text-center">
                                            <p class="text-xs sm:text-sm text-gray-500">No pending admin tasks</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}

                                <!-- User Notifications Section -->
                                <div>
                                    <div class="p-2 sm:p-3 bg-green-50">
                                        <h4 class="text-xs sm:text-sm font-semibold text-green-900 flex items-center">
                                            <i class="fas fa-user mr-1 sm:mr-2 text-xs sm:text-sm"></i>
                                            <span class="hidden sm:inline">My Notifications</span>
                                            <span class="sm:hidden">Messages</span>
                                        </h4>
                                    </div>
                                    <div id="notification-list" class="max-h-32 sm:max-h-64 overflow-y-auto">
                                        <!-- User notifications will be loaded here -->
                                    </div>
                                </div>

                                <div class="p-3 sm:p-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">
                                    <div class="flex flex-col sm:flex-row justify-between gap-2">
                                        <a href="{% url 'notifications_list' %}" class="text-xs sm:text-sm text-blue-600 hover:text-blue-800 font-medium text-center sm:text-left">View all notifications</a>
                                        {% if user.role == 'librarian' or user.role == 'admin' or user.is_superuser %}
                                        <a href="{% url 'reports_dashboard' %}" class="text-xs sm:text-sm text-blue-600 hover:text-blue-800 font-medium text-center sm:text-right">Admin Dashboard</a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Profile dropdown -->
                        <div class="relative">
                            <div class="relative group">
                                <button class="flex items-center space-x-2 bg-white/10 hover:bg-white/20 rounded-lg px-2 py-2 focus:outline-none focus:ring-2 focus:ring-white/50 transition-all duration-200">
                                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center shadow-sm">
                                        {% if user.profile_picture %}
                                        <img src="{{ user.profile_picture.url }}" alt="Profile" class="w-8 h-8 rounded-full object-cover">
                                        {% else %}
                                        <i class="fas fa-user text-white text-sm"></i>
                                        {% endif %}
                                    </div>
                                    <!-- User name (hidden on mobile) -->
                                    <div class="hidden sm:block text-left">
                                        <p class="text-sm font-medium text-white">{{ user.get_full_name|truncatechars:15 }}</p>
                                        <p class="text-xs text-white/70">{{ user.get_role_display }}</p>
                                    </div>
                                    <i class="fas fa-chevron-down text-white/70 text-xs hidden sm:block"></i>
                                </button>

                                <!-- Dropdown menu (styled like sidebar) -->
                                <div class="origin-top-right absolute right-0 mt-2 w-56 rounded-xl shadow-lg bg-white ring-1 ring-black ring-opacity-5 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 border border-gray-100">
                                    <div class="p-3 border-b border-gray-100">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                                {% if user.profile_picture %}
                                                <img src="{{ user.profile_picture.url }}" alt="Profile" class="w-10 h-10 rounded-full object-cover">
                                                {% else %}
                                                <i class="fas fa-user text-white"></i>
                                                {% endif %}
                                            </div>
                                            <div class="flex-1">
                                                <p class="text-sm font-semibold text-gray-900">{{ user.get_full_name }}</p>
                                                <p class="text-xs text-gray-500">{{ user.get_role_display }}</p>
                                                <p class="text-xs text-blue-600">{{ user.email|truncatechars:25 }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="py-2">
                                        <a href="{% url 'profile' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                                            <i class="fas fa-user-circle mr-3 text-gray-400"></i>
                                            Your Profile
                                        </a>
                                        <a href="{% url 'logout' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                                            <i class="fas fa-sign-out-alt mr-3 text-gray-400"></i>
                                            Sign out
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <main class="flex-1 relative focus:outline-none">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
                        {% block content %}{% endblock %}
                    </div>
                </div>
            </main>
        </div>
    </div>
    {% else %}
    <!-- Non-authenticated layout -->
    <main class="flex-1">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            {% block content_unauthenticated %}{% endblock %}
        </div>
    </main>
    {% endif %}

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-slate-800 to-slate-900 text-white mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <!-- Library Info -->
                <div class="md:col-span-2">
                    <div class="flex items-center space-x-3 mb-4">
                        {% if library_settings.library_logo %}
                            {% load library_settings_tags %}
                            <img src="{% safe_cloudinary_url library_settings.library_logo width=40 height=40 crop='fill' %}"
                                 alt="{{ library_settings.library_name }} Logo"
                                 class="w-10 h-10 rounded-lg object-cover">
                        {% else %}
                            <i class="fas fa-book-open text-2xl text-blue-400"></i>
                        {% endif %}
                        <h3 class="text-xl font-bold">{{ library_settings.library_name|default:"LibraryPro" }}</h3>
                    </div>
                    <p class="text-gray-300 mb-4">
                        {% if library_settings.library_address %}
                            {{ library_settings.library_address }}
                        {% else %}
                            A comprehensive library management system designed for Deigratia Montessori School.
                            Manage books, users, loans, and reservations with ease.
                        {% endif %}
                    </p>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-blue-400 transition-colors duration-200">
                            <i class="fab fa-facebook text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-blue-400 transition-colors duration-200">
                            <i class="fab fa-twitter text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-blue-400 transition-colors duration-200">
                            <i class="fab fa-linkedin text-xl"></i>
                        </a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div>
                    <h4 class="text-lg font-semibold mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="{% url 'home' %}" class="text-gray-300 hover:text-white transition-colors duration-200">Dashboard</a></li>
                        <li><a href="{% url 'book_list' %}" class="text-gray-300 hover:text-white transition-colors duration-200">Browse Books</a></li>
                        {% if user.is_authenticated %}
                        <li><a href="{% url 'profile' %}" class="text-gray-300 hover:text-white transition-colors duration-200">My Profile</a></li>
                        {% endif %}
                    </ul>
                </div>

                <!-- Contact Info -->
                <div>
                    <h4 class="text-lg font-semibold mb-4">Contact</h4>
                    <ul class="space-y-2 text-gray-300">
                        {% if library_settings.library_email %}
                        <li class="flex items-center">
                            <i class="fas fa-envelope mr-2 text-blue-400"></i>
                            {{ library_settings.library_email }}
                        </li>
                        {% endif %}
                        {% if library_settings.library_phone %}
                        <li class="flex items-center">
                            <i class="fas fa-phone mr-2 text-blue-400"></i>
                            {{ library_settings.library_phone }}
                        </li>
                        {% endif %}
                        {% if library_settings.library_address %}
                        <li class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 text-blue-400"></i>
                            {{ library_settings.library_address|truncatewords:10 }}
                        </li>
                        {% endif %}
                        {% if not library_settings.library_email and not library_settings.library_phone and not library_settings.library_address %}
                        <li class="flex items-center">
                            <i class="fas fa-info-circle mr-2 text-blue-400"></i>
                            Contact information not configured
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <div class="border-t border-gray-700 mt-8 pt-8 text-center">
                <p class="text-gray-400">
                    &copy; {% now "Y" %} {{ library_settings.library_name|default:"LibraryPro" }} Management System. All rights reserved.
                </p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }

        // Auto-hide messages after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const messages = document.querySelectorAll('[class*="animate-slide-in"]');
            messages.forEach(function(message) {
                setTimeout(function() {
                    message.style.opacity = '0';
                    message.style.transform = 'translateX(100%)';
                    setTimeout(function() {
                        message.remove();
                    }, 300);
                }, 5000);
            });
        });

        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Add loading states to buttons
        document.querySelectorAll('button[type="submit"], .btn-primary').forEach(button => {
            button.addEventListener('click', function() {
                if (this.type === 'submit') {
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
                    this.disabled = true;

                    // Re-enable after 3 seconds (fallback)
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }, 3000);
                }
            });
        });

        // Notification System
        function loadNotifications() {
            fetch('/api/notifications/')
                .then(response => {
                    if (response.status === 401) {
                        // User not authenticated, don't show error
                        updateNotificationUI([], 0);
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data) {
                        updateNotificationUI(data.notifications, data.unread_count);
                    }
                })
                .catch(error => {
                    console.error('Error loading notifications:', error);
                    updateNotificationUI([], 0);
                });
        }

        function updateNotificationUI(notifications, unreadCount) {
            const badge = document.getElementById('notification-badge');
            const notificationList = document.getElementById('notification-list');

            // Calculate total notifications including admin notifications from template context
            let totalNotifications = unreadCount;

            // Add admin notifications count if available (from template context)
            if (window.adminNotificationsCount) {
                totalNotifications += window.adminNotificationsCount;
            }

            if (totalNotifications > 0) {
                badge.textContent = totalNotifications;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            if (notifications.length > 0) {
                notificationList.innerHTML = notifications.map(notification => `
                    <div class="px-3 sm:px-4 py-2 sm:py-3 hover:bg-gray-50 border-b border-gray-100 cursor-pointer ${!notification.is_read ? 'bg-blue-50' : ''}"
                         onclick="markNotificationRead('${notification.id}')">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <div class="w-2 h-2 rounded-full ${getNotificationColor(notification.notification_type)} mt-2"></div>
                            </div>
                            <div class="ml-2 sm:ml-3 flex-1 min-w-0">
                                <p class="text-xs sm:text-sm font-medium text-gray-900 truncate">${notification.title}</p>
                                <p class="text-xs sm:text-sm text-gray-500 line-clamp-2">${notification.message}</p>
                                <p class="text-xs text-gray-400 mt-1">${formatNotificationTime(notification.created_at)}</p>
                            </div>
                            ${!notification.is_read ? '<div class="w-2 h-2 bg-blue-500 rounded-full flex-shrink-0"></div>' : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                notificationList.innerHTML = '<div class="px-3 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm text-gray-500 text-center">No notifications</div>';
            }
        }

        function formatNotificationTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));

            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
            return `${Math.floor(diffInMinutes / 1440)}d ago`;
        }

        function getNotificationColor(type) {
            switch(type) {
                case 'book_due': return 'bg-yellow-400';
                case 'book_overdue': return 'bg-red-400';
                case 'book_returned': return 'bg-green-400';
                case 'request_approved': return 'bg-green-400';
                case 'request_rejected': return 'bg-red-400';
                default: return 'bg-blue-400';
            }
        }

        function markNotificationRead(notificationId) {
            fetch(`/api/notifications/${notificationId}/read/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadNotifications(); // Refresh notifications
                }
            })
            .catch(error => {
                console.error('Error marking notification as read:', error);
            });
        }

        function markAllNotificationsRead() {
            fetch('/api/notifications/mark-all-read/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadNotifications(); // Refresh notifications
                }
            })
            .catch(error => {
                console.error('Error marking all notifications as read:', error);
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Toggle sidebar for mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            if (sidebar && overlay) {
                const isHidden = sidebar.classList.contains('-translate-x-full');

                if (isHidden) {
                    // Show sidebar
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                } else {
                    // Hide sidebar
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            }
        }

        // Close sidebar when clicking overlay
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            if (sidebar && overlay) {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        // Live Search Functionality
        let searchTimeout;
        function setupLiveSearch() {
            const searchField = document.getElementById('search-field');
            const searchResults = document.getElementById('search-results');

            if (searchField && searchResults) {
                searchField.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    const query = this.value.trim();

                    if (query.length >= 2) {
                        searchTimeout = setTimeout(() => {
                            performLiveSearch(query);
                        }, 300);
                    } else {
                        searchResults.classList.add('hidden');
                    }
                });

                // Hide results when clicking outside
                document.addEventListener('click', function(e) {
                    if (!searchField.contains(e.target) && !searchResults.contains(e.target)) {
                        searchResults.classList.add('hidden');
                    }
                });
            }
        }

        function performLiveSearch(query) {
            const searchResults = document.getElementById('search-results');

            fetch(`/api/live-search/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displaySearchResults(data);
                    searchResults.classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Search error:', error);
                });
        }

        function displaySearchResults(data) {
            const searchResults = document.getElementById('search-results');

            if (data.books.length === 0 && data.users.length === 0) {
                searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">No results found</div>';
                return;
            }

            let html = '';

            if (data.books.length > 0) {
                html += '<div class="p-3 border-b border-gray-200"><h4 class="font-semibold text-gray-900 text-sm">Books</h4></div>';
                data.books.forEach(book => {
                    html += `
                        <a href="/books/${book.id}/" class="block p-3 hover:bg-gray-50 transition-colors duration-200">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-blue-100 rounded flex items-center justify-center mr-3">
                                    <i class="fas fa-book text-blue-600 text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900">${book.title}</p>
                                    <p class="text-xs text-gray-500">by ${book.authors}</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full ${book.available ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${book.available ? 'Available' : 'Borrowed'}
                                </span>
                            </div>
                        </a>
                    `;
                });
            }

            if (data.users.length > 0 && (window.userRole === 'admin' || window.userRole === 'librarian')) {
                html += '<div class="p-3 border-b border-gray-200"><h4 class="font-semibold text-gray-900 text-sm">Users</h4></div>';
                data.users.forEach(user => {
                    html += `
                        <a href="/users/${user.id}/" class="block p-3 hover:bg-gray-50 transition-colors duration-200">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-green-100 rounded flex items-center justify-center mr-3">
                                    <i class="fas fa-user text-green-600 text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900">${user.name}</p>
                                    <p class="text-xs text-gray-500">${user.role} - ${user.email}</p>
                                </div>
                            </div>
                        </a>
                    `;
                });
            }

            searchResults.innerHTML = html;
        }

        // Set global variables for JavaScript
        window.adminNotificationsCount = {{ total_admin_notifications|default:0 }};
        window.userRole = '{{ user.role|default:"" }}';

        // Load notifications and setup event handlers on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadNotifications();
            setupLiveSearch();

            // Ensure search field is working properly
            const searchField = document.getElementById('search-field');
            if (searchField) {
                // Ensure the search field is enabled and focusable
                searchField.disabled = false;
                searchField.readOnly = false;
                searchField.style.pointerEvents = 'auto';
            }

            // Refresh notifications every 2 minutes
            setInterval(loadNotifications, 120000);

            // Add click handler for sidebar overlay
            const overlay = document.getElementById('sidebar-overlay');
            if (overlay) {
                overlay.addEventListener('click', closeSidebar);
            }
        });
    </script>

    <!-- Custom JavaScript -->
    <script src="{% static 'js/library.js' %}"></script>

    {% block extra_js %}{% endblock %}
</body>
</html>
